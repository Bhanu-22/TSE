name: Cleanup Saved Configs From All Branches
 
on:

  workflow_dispatch:   # ‚úÖ Manual trigger

  schedule:

    - cron: "0 3 * * 1"  # ‚úÖ Optional: Runs every Monday at 3 AM
 
jobs:

  cleanup:

    runs-on: ubuntu-latest
 
    steps:

      - name: Checkout repository

        uses: actions/checkout@v4

        with:

          fetch-depth: 0 # ‚úÖ Required to access all branches
 
      - name: Setup Node

        uses: actions/setup-node@v4

        with:

          node-version: 20
 
      - name: Install Octokit

        run: |

          npm install @octokit/rest
 
      - name: Run cleanup script

        env:

          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          REPO_OWNER: ${{ github.repository_owner }}

          REPO_NAME: ${{ github.event.repository.name }}

        run: |

          node << 'EOF'

          const { Octokit } = require("@octokit/rest");
 
          const octokit = new Octokit({

            auth: process.env.GITHUB_TOKEN

          });
 
          const owner = process.env.REPO_OWNER;

          const repo = process.env.REPO_NAME;
 
          (async () => {

            try {

              console.log("üìå Fetching branches...");
 
              // ‚úÖ 1. List all branches

              const { data: branches } = await octokit.repos.listBranches({

                owner,

                repo

              });
 
              const branchesToClean = branches.filter(b => b.name !== "main");
 
              console.log("‚úÖ Branches to clean:", branchesToClean.map(b => b.name));
 
              for (const branch of branchesToClean) {

                console.log(`\n‚è≥ Cleaning branch: ${branch.name}`);
 
                // ‚úÖ 2. Get branch reference

                const { data: refData } = await octokit.git.getRef({

                  owner,

                  repo,

                  ref: `heads/${branch.name}`,

                });
 
                const branchSha = refData.object.sha;
 
                // ‚úÖ 3. Get full tree

                const { data: treeData } = await octokit.git.getTree({

                  owner,

                  repo,

                  tree_sha: branchSha,

                  recursive: "true"

                });
 
                // ‚úÖ 4. Remove saved-configs/ folder

                const filteredTree = treeData.tree.filter(item => {

                  return !item.path.startsWith("saved-configs/");

                });
 
                console.log(

                  `üìÅ Removed ${

                    treeData.tree.length - filteredTree.length

                  } items from ${branch.name}`

                );
 
                // ‚úÖ 5. Create new tree

                const { data: newTree } = await octokit.git.createTree({

                  owner,

                  repo,

                  base_tree: treeData.sha,

                  tree: filteredTree

                });
 
                // ‚úÖ 6. Create commit

                const { data: newCommit } = await octokit.git.createCommit({

                  owner,

                  repo,

                  message: "Cleanup: removed saved-configs folder",

                  tree: newTree.sha,

                  parents: [branchSha]

                });
 
                // ‚úÖ 7. Update branch pointer

                await octokit.git.updateRef({

                  owner,

                  repo,

                  ref: `heads/${branch.name}`,

                  sha: newCommit.sha,

                  force: true

                });
 
                console.log(`‚úÖ Updated branch ${branch.name}`);

              }
 
              console.log("\nüéâ Cleanup complete for all branches!");

            } catch (error) {

              console.error("‚ùå ERROR:", error);

              process.exit(1);

            }

          })();

          EOF

 